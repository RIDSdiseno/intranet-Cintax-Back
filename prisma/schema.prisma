generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Trabajador {
  id_trabajador      Int              @id @default(autoincrement())
  nombre             String
  email              String           @unique
  passwordHash       String?
  googleId           String?          @unique
  status             Boolean          @default(true)
  createdAt          DateTime         @default(now())
  googleRefreshToken String?
  areaInterna        Area?
  lastActivityAt     DateTime?
  tipoRelacion       TipoRelacion?
  carpetaDriveCodigo String?          @db.VarChar(50)

  refreshTokens      RefreshToken[]
  tareasAsignadas    TareaAsignada[]  @relation("TrabajadorTareas")
  tareasDefault      TareaPlantilla[] @relation("TareaResponsableDefault")
  tickets            Ticket[]

  ticketMessages     TicketMessage[]  @relation("TicketMessageAuthor")
}

model RefreshToken {
  id           Int        @id @default(autoincrement())
  tokenHash    String
  expiresAt    DateTime
  createdAt    DateTime   @default(now())
  trabajadorId Int
  trabajador   Trabajador @relation(fields: [trabajadorId], references: [id_trabajador], onDelete: Cascade)
}

model Ticket {
  id_ticket      Int          @id @default(autoincrement())
  subject        String
  description    String
  categoria      String
  estado         String
  prioridad      Int?
  requesterEmail String

  freshdeskId    Int?         @unique
  trabajadorId   Int?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  gmailThreadId  String?      @unique
  source         TicketSource @default(MANUAL)

  areaAsignada   Area?

  trabajador     Trabajador?     @relation(fields: [trabajadorId], references: [id_trabajador])
  messages       TicketMessage[]  @relation("TicketMessages")

  @@index([createdAt])
  @@index([estado])
  @@index([categoria])
  @@index([areaAsignada])
}

model TicketMessage {
  id                 Int                   @id @default(autoincrement())
  ticketId           Int
  authorTrabajadorId Int?
  type               TicketMessageType
  direction          TicketMessageDirection @default(INBOUND)

  gmailMessageId     String?               @unique

  toEmail            String?
  cc                 String?
  bcc                String?
  subject            String?
  bodyHtml           String
  bodyText           String?
  createdAt          DateTime              @default(now())

  ticket             Ticket                @relation("TicketMessages", fields: [ticketId], references: [id_ticket], onDelete: Cascade)
  author             Trabajador?           @relation("TicketMessageAuthor", fields: [authorTrabajadorId], references: [id_trabajador], onDelete: SetNull)

  attachments        TicketAttachment[]

  @@index([ticketId, createdAt])
  @@index([authorTrabajadorId])
}

model TicketAttachment {
  id        Int           @id @default(autoincrement())
  messageId Int
  filename  String
  mimeType  String
  size      Int
  url       String
  createdAt DateTime      @default(now())

  message   TicketMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

model TareaPlantilla {
  id_tarea_plantilla   Int             @id @default(autoincrement())
  area                 Area
  nombre               String

  // ✅ NUEVO: clave normalizada para evitar duplicados por MAY/MIN/espacios
  // Ej: "Declaración IVA" -> "declaración iva"
  nombreNorm           String          @unique

  detalle              String
  frecuenciaTexto      String?
  plazoMaximoTexto     String?
  frecuencia           FrecuenciaTarea
  diaMesVencimiento    Int?
  diaSemanaVencimiento Int?
  presentacion         Presentacion
  activo               Boolean         @default(true)
  responsableDefaultId Int?
  codigoDocumento      String?
  requiereDrive        Boolean         @default(true)

  tareasAsignadas      TareaAsignada[]
  responsableDefault   Trabajador?     @relation("TareaResponsableDefault", fields: [responsableDefaultId], references: [id_trabajador])

  @@index([area])
  @@index([responsableDefaultId])
}

model TareaAsignada {
  id_tarea_asignada  Int            @id @default(autoincrement())
  tareaPlantillaId   Int
  trabajadorId       Int?
  estado             EstadoTarea    @default(PENDIENTE)
  fechaProgramada    DateTime
  fechaComplecion    DateTime?
  comentarios        String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  rutCliente         String?
  driveTareaFolderId String?        @db.VarChar(255)

  tareaPlantilla     TareaPlantilla @relation(fields: [tareaPlantillaId], references: [id_tarea_plantilla])
  asignado           Trabajador?    @relation("TrabajadorTareas", fields: [trabajadorId], references: [id_trabajador])

  notificaciones     Notificacion[] @relation("NotificacionTarea")

  @@index([trabajadorId])
  @@index([rutCliente])
  @@index([tareaPlantillaId])

  // ✅ NUEVO: evita repetir tareas programadas para el mismo cliente y plantilla en la misma fecha
  // Ojo: como rutCliente es nullable, los NULL no chocan entre sí (comportamiento Postgres).
  @@unique([rutCliente, tareaPlantillaId, fechaProgramada])
}

model Cliente {
  id            Int      @id @default(autoincrement())
  rut           String   @unique   // ✅ NUEVO: evita duplicados de cliente por RUT
  razonSocial   String
  alias         String?
  activo        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  agenteId      Int?
  codigoCartera String?

  @@index([agenteId])
  @@index([codigoCartera])
}

model Notificacion {
  id           Int      @id @default(autoincrement())
  mensaje      String
  leida        Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  trabajadorId Int
  tareaId      Int

  tarea        TareaAsignada @relation("NotificacionTarea", fields: [tareaId], references: [id_tarea_asignada])

  @@index([tareaId])
  @@index([trabajadorId])
}

model ClienteTareaExclusion {
  id               Int       @id @default(autoincrement())
  rutCliente       String
  tareaPlantillaId Int
  activa           Boolean   @default(true)
  motivo           String?   @db.VarChar(500)
  desdeFecha       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime

  @@unique([rutCliente, tareaPlantillaId])
  @@index([rutCliente])
  @@index([tareaPlantillaId])
}

enum TipoRelacion {
  CLIENTES
  PROVEEDORES
  INTERNO
}

enum Area {
  CONTA
  ADMIN
  RRHH
  TRIBUTARIO
}

enum Presentacion {
  CLIENTE
  INTERNO
}

enum EstadoTarea {
  PENDIENTE
  EN_PROCESO
  COMPLETADA
  VENCIDA
  NO_APLICA
}

enum FrecuenciaTarea {
  MENSUAL
  SEMANAL
  UNICA
}

enum TicketMessageType {
  PUBLIC_REPLY
  INTERNAL_NOTE
  FORWARD
}

enum TicketSource {
  MANUAL
  EMAIL
  FRESHDESK
}

enum TicketMessageDirection {
  INBOUND
  OUTBOUND
}
